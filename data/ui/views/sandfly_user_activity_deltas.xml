<!--
=============================================================================
 default/data/ui/views/sandfly_user_activity_deltas.xml
 Sandfly Security for Splunk App
 User Activity Deltas (DoD / WoW / MoM)
=============================================================================

PURPOSE

This dashboard provides executive-friendly change metrics (deltas) for Sandfly
user activity and access posture over time, derived from Sandfly /v4/users data.

This view answers:

- How many users exist today, and how is that changing (DoD / WoW / MoM)?
- Are admin users increasing?
- Are SSO-disabled accounts increasing (higher risk)?
- Are never-logged-in accounts accumulating?
- How is inactivity trending (30/60/90/180/365 days)?
- What are the highest-risk user conditions right now?

DATA SOURCE

- /v4/users  ‚Üí sourcetype=sandfly:users
  Expected event shape (per user record):
    created_date (ISO 8601)
    last_login_date (ISO 8601 or null/empty)
    last_login_ip
    email
    full_name
    roles (array)
    sso (boolean)
    username

NOTES

- All time math is performed in Splunk SPL using explicit time windows.
- Deltas compare current window vs previous window:
    DoD:  last 24h vs prior 24h
    WoW:  last 7d  vs prior 7d
    MoM:  last 30d vs prior 30d
- SPL uses explicit spath everywhere for nested/JSON fields.

=============================================================================
-->

<dashboard version="1.1" theme="light">
  <label>Users ‚Äî Activity Deltas</label>

  <description>
    Executive change metrics for Sandfly user posture: totals, admins, SSO-disabled,
    never-logged-in, and inactivity drift (DoD / WoW / MoM), derived from sandfly:users.
  </description>

  <!-- =================================================================== -->
  <!-- ROW 1: TOTAL USERS DELTA                                           -->
  <!-- =================================================================== -->
  <row>
    <panel>
      <title>üë§ Total Users (DoD / WoW / MoM)</title>
      <table>
        <search>
          <query>
            index=* sourcetype=sandfly:users
            | spath
            | eval created_epoch=coalesce(
                strptime(created_date,"%Y-%m-%dT%H:%M:%S.%3NZ"),
                strptime(created_date,"%Y-%m-%dT%H:%M:%SZ")
              )
            | eval now_epoch=now()

            | eval in_dod=created_epoch>=now_epoch-86400
            | eval in_prev_dod=created_epoch>=now_epoch-172800 AND created_epoch<now_epoch-86400
            | eval in_wow=created_epoch>=now_epoch-604800
            | eval in_prev_wow=created_epoch>=now_epoch-1209600 AND created_epoch<now_epoch-604800
            | eval in_mom=created_epoch>=now_epoch-2592000
            | eval in_prev_mom=created_epoch>=now_epoch-5184000 AND created_epoch<now_epoch-2592000

            | stats
                count as total_users
                sum(in_dod) as new_dod
                sum(in_prev_dod) as prev_dod
                sum(in_wow) as new_wow
                sum(in_prev_wow) as prev_wow
                sum(in_mom) as new_mom
                sum(in_prev_mom) as prev_mom

            | eval DoD=new_dod-prev_dod
            | eval WoW=new_wow-prev_wow
            | eval MoM=new_mom-prev_mom

            | table total_users DoD WoW MoM
            | rename total_users as "Current Total"
          </query>
        </search>
      </table>
    </panel>
  </row>

  <!-- =================================================================== -->
  <!-- ROW 2: ADMIN USERS DELTA                                           -->
  <!-- =================================================================== -->
  <row>
    <panel>
      <title>üîê Admin Users (DoD / WoW / MoM)</title>
      <table>
        <search>
          <query>
            index=* sourcetype=sandfly:users
            | spath
            | eval created_epoch=coalesce(
                strptime(created_date,"%Y-%m-%dT%H:%M:%S.%3NZ"),
                strptime(created_date,"%Y-%m-%dT%H:%M:%SZ")
              )
            | eval now_epoch=now()
            | eval is_admin=if(match(tostring(roles),"admin"),1,0)

            | eval in_dod=created_epoch>=now_epoch-86400
            | eval in_prev_dod=created_epoch>=now_epoch-172800 AND created_epoch<now_epoch-86400
            | eval in_wow=created_epoch>=now_epoch-604800
            | eval in_prev_wow=created_epoch>=now_epoch-1209600 AND created_epoch<now_epoch-604800
            | eval in_mom=created_epoch>=now_epoch-2592000
            | eval in_prev_mom=created_epoch>=now_epoch-5184000 AND created_epoch<now_epoch-2592000

            | stats
                sum(is_admin) as admins
                sum(is_admin*in_dod) as new_dod
                sum(is_admin*in_prev_dod) as prev_dod
                sum(is_admin*in_wow) as new_wow
                sum(is_admin*in_prev_wow) as prev_wow
                sum(is_admin*in_mom) as new_mom
                sum(is_admin*in_prev_mom) as prev_mom

            | eval DoD=new_dod-prev_dod
            | eval WoW=new_wow-prev_wow
            | eval MoM=new_mom-prev_mom

            | table admins DoD WoW MoM
            | rename admins as "Current Admins"
          </query>
        </search>
      </table>
    </panel>
  </row>

  <!-- =================================================================== -->
  <!-- ROW 3: SSO DISABLED + NEVER LOGGED IN                               -->
  <!-- =================================================================== -->
  <row>
    <panel>
      <title>üîì SSO Disabled (DoD / WoW / MoM)</title>
      <table>
        <search>
          <query>
            index=* sourcetype=sandfly:users
            | spath
            | eval created_epoch=coalesce(
                strptime(created_date,"%Y-%m-%dT%H:%M:%S.%3NZ"),
                strptime(created_date,"%Y-%m-%dT%H:%M:%SZ")
              )
            | eval now_epoch=now()
            | eval sso_disabled=if(sso=false,1,0)

            | eval in_dod=created_epoch>=now_epoch-86400
            | eval in_prev_dod=created_epoch>=now_epoch-172800 AND created_epoch<now_epoch-86400
            | eval in_wow=created_epoch>=now_epoch-604800
            | eval in_prev_wow=created_epoch>=now_epoch-1209600 AND created_epoch<now_epoch-604800
            | eval in_mom=created_epoch>=now_epoch-2592000
            | eval in_prev_mom=created_epoch>=now_epoch-5184000 AND created_epoch<now_epoch-2592000

            | stats
                sum(sso_disabled) as current
                sum(sso_disabled*in_dod) as new_dod
                sum(sso_disabled*in_prev_dod) as prev_dod
                sum(sso_disabled*in_wow) as new_wow
                sum(sso_disabled*in_prev_wow) as prev_wow
                sum(sso_disabled*in_mom) as new_mom
                sum(sso_disabled*in_prev_mom) as prev_mom

            | eval DoD=new_dod-prev_dod
            | eval WoW=new_wow-prev_wow
            | eval MoM=new_mom-prev_mom

            | table current DoD WoW MoM
            | rename current as "SSO Disabled"
          </query>
        </search>
      </table>
    </panel>

    <panel>
      <title>üï≥Ô∏è Never Logged In (Current)</title>
      <table>
        <search>
          <query>
            index=* sourcetype=sandfly:users
            | spath
            | eval last_login_epoch=coalesce(
                strptime(last_login_date,"%Y-%m-%dT%H:%M:%S.%3NZ"),
                strptime(last_login_date,"%Y-%m-%dT%H:%M:%SZ")
              )
            | where isnull(last_login_epoch)
            | stats count as users
            | rename users as "Never Logged In"
          </query>
        </search>
      </table>
    </panel>
  </row>

</dashboard>
