<!--
=============================================================================
 default/data/ui/views/sandfly_user_activity_deltas.xml
 Sandfly Security for Splunk App
 User Activity Deltas (DoD / WoW / MoM)
=============================================================================
-->

<dashboard version="1.1" theme="light">
  <label>ğŸ“ˆ Users â€” Activity Deltas</label>

  <description>
    Executive change metrics for Sandfly user posture: totals, admins,
    SSO-disabled users, never-logged-in users, and access drift over time
    (DoD / WoW / MoM).
  </description>

  <!-- =============================================================== -->
  <!-- ROW 1: TOTAL USERS DELTA                                       -->
  <!-- =============================================================== -->
  <row>
    <panel>
      <title>ğŸ‘¤ Total Users (DoD / WoW / MoM)</title>
      <table>
        <search>
          <query>
            index=* sourcetype=sandfly:users
            | spath
            | eval created_epoch=coalesce(
                strptime(created_date,"%Y-%m-%dT%H:%M:%S.%3NZ"),
                strptime(created_date,"%Y-%m-%dT%H:%M:%SZ")
              )
            | eval now_epoch=now()

            | eval in_dod=created_epoch>=now_epoch-86400
            | eval in_prev_dod=created_epoch>=now_epoch-172800 AND created_epoch<now_epoch-86400
            | eval in_wow=created_epoch>=now_epoch-604800
            | eval in_prev_wow=created_epoch>=now_epoch-1209600 AND created_epoch<now_epoch-604800
            | eval in_mom=created_epoch>=now_epoch-2592000
            | eval in_prev_mom=created_epoch>=now_epoch-5184000 AND created_epoch<now_epoch-2592000

            | stats
                count as total_users
                sum(in_dod) as new_dod
                sum(in_prev_dod) as prev_dod
                sum(in_wow) as new_wow
                sum(in_prev_wow) as prev_wow
                sum(in_mom) as new_mom
                sum(in_prev_mom) as prev_mom

            | eval DoD=new_dod-prev_dod
            | eval WoW=new_wow-prev_wow
            | eval MoM=new_mom-prev_mom

            | table total_users DoD WoW MoM
            | rename total_users as "Current Total"
          </query>
        </search>
      </table>
    </panel>
  </row>

  <!-- =============================================================== -->
  <!-- ROW 2: ADMIN USERS DELTA                                       -->
  <!-- =============================================================== -->
  <row>
    <panel>
      <title>ğŸ” Admin Users (DoD / WoW / MoM)</title>
      <table>
        <search>
          <query>
            index=* sourcetype=sandfly:users
            | spath
            | eval created_epoch=coalesce(
                strptime(created_date,"%Y-%m-%dT%H:%M:%S.%3NZ"),
                strptime(created_date,"%Y-%m-%dT%H:%M:%SZ")
              )
            | eval now_epoch=now()
            | eval is_admin=if(mvfind(roles,"admin")&gt;=0,1,0)

            | eval in_dod=created_epoch>=now_epoch-86400
            | eval in_prev_dod=created_epoch>=now_epoch-172800 AND created_epoch<now_epoch-86400
            | eval in_wow=created_epoch>=now_epoch-604800
            | eval in_prev_wow=created_epoch>=now_epoch-1209600 AND created_epoch<now_epoch-604800
            | eval in_mom=created_epoch>=now_epoch-2592000
            | eval in_prev_mom=created_epoch>=now_epoch-5184000 AND created_epoch<now_epoch-2592000

            | stats
                sum(is_admin) as admins
                sum(is_admin*in_dod) as new_dod
                sum(is_admin*in_prev_dod) as prev_dod
                sum(is_admin*in_wow) as new_wow
                sum(is_admin*in_prev_wow) as prev_wow
                sum(is_admin*in_mom) as new_mom
                sum(is_admin*in_prev_mom) as prev_mom

            | eval DoD=new_dod-prev_dod
            | eval WoW=new_wow-prev_wow
            | eval MoM=new_mom-prev_mom

            | table admins DoD WoW MoM
            | rename admins as "Current Admins"
          </query>
        </search>
      </table>
    </panel>
  </row>

  <!-- =============================================================== -->
  <!-- ROW 3: SSO DISABLED + NEVER LOGGED IN                           -->
  <!-- =============================================================== -->
  <row>
    <panel>
      <title>ğŸ”“ SSO Disabled (DoD / WoW / MoM)</title>
      <table>
        <search>
          <query>
            index=* sourcetype=sandfly:users
            | spath
            | eval created_epoch=coalesce(
                strptime(created_date,"%Y-%m-%dT%H:%M:%S.%3NZ"),
                strptime(created_date,"%Y-%m-%dT%H:%M:%SZ")
              )
            | eval now_epoch=now()
            | eval sso_disabled=if(isnotnull(sso) AND sso="false",1,0)

            | eval in_dod=created_epoch>=now_epoch-86400
            | eval in_prev_dod=created_epoch>=now_epoch-172800 AND created_epoch<now_epoch-86400
            | eval in_wow=created_epoch>=now_epoch-604800
            | eval in_prev_wow=created_epoch>=now_epoch-1209600 AND created_epoch<now_epoch-604800
            | eval in_mom=created_epoch>=now_epoch-2592000
            | eval in_prev_mom=created_epoch>=now_epoch-5184000 AND created_epoch<now_epoch-2592000

            | stats
                sum(sso_disabled) as current
                sum(sso_disabled*in_dod) as new_dod
                sum(sso_disabled*in_prev_dod) as prev_dod
                sum(sso_disabled*in_wow) as new_wow
                sum(sso_disabled*in_prev_wow) as prev_wow
                sum(sso_disabled*in_mom) as new_mom
                sum(sso_disabled*in_prev_mom) as prev_mom

            | eval DoD=new_dod-prev_dod
            | eval WoW=new_wow-prev_wow
            | eval MoM=new_mom-prev_mom

            | table current DoD WoW MoM
            | rename current as "SSO Disabled"
          </query>
        </search>
      </table>
    </panel>

    <panel>
      <title>ğŸ•³ï¸ Never Logged In</title>
      <table>
        <search>
          <query>
            index=* sourcetype=sandfly:users
            | spath
            | eval last_login_epoch=coalesce(
                strptime(last_login_date,"%Y-%m-%dT%H:%M:%S.%3NZ"),
                strptime(last_login_date,"%Y-%m-%dT%H:%M:%SZ")
              )
            | where isnull(last_login_epoch)
            | stats count as users
            | rename users as "Never Logged In"
          </query>
        </search>
      </table>
    </panel>
  </row>

</dashboard>
