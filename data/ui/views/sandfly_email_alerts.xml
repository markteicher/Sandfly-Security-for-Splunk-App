<!--
=============================================================================
 default/data/ui/views/sandfly_email_alerts.xml
 Sandfly Security for Splunk App
 Email Alerts Configuration & Risk Overview
=============================================================================

PURPOSE

Provides visibility into Sandfly email alert configurations.

Data Source:
- GET /v4/alerts/email
- Sourcetype: sandfly:alerts:email

=============================================================================
-->

<dashboard version="1.1" theme="light">
  <label>ğŸ“§ Email Alerts</label>

  <!-- =============================================================== -->
  <!-- ROW 1: EXECUTIVE OVERVIEW                                       -->
  <!-- =============================================================== -->
  <row>

    <panel>
      <title>ğŸ“§ Total Email Alerts</title>
      <single>
        <search>
          <query>
            index=* sourcetype=sandfly:alerts:email
            | stats count
          </query>
        </search>
      </single>
    </panel>

    <panel>
      <title>ğŸ‘¥ Unique Recipients</title>
      <single>
        <search>
          <query>
            index=* sourcetype=sandfly:alerts:email
            | mvexpand email_recipients
            | stats dc(email_recipients)
          </query>
        </search>
      </single>
    </panel>

    <panel>
      <title>ğŸ–¥ï¸ Mail Servers in Use</title>
      <single>
        <search>
          <query>
            index=* sourcetype=sandfly:alerts:email
            | stats dc(mail_server)
          </query>
        </search>
      </single>
    </panel>

    <panel>
      <title>âš ï¸ Potentially Misconfigured Alerts</title>
      <single>
        <search>
          <query>
            index=* sourcetype=sandfly:alerts:email
            | eval missing_recipients=if(mvcount(email_recipients)=0,1,0)
            | eval missing_sender=if(isnull(email_sender) OR email_sender="",1,0)
            | eval missing_server=if(isnull(mail_server) OR mail_server="",1,0)
            | eval misconfigured=if(missing_recipients=1 OR missing_sender=1 OR missing_server=1,1,0)
            | stats sum(misconfigured) as misconfigured_alerts
          </query>
        </search>
      </single>
    </panel>

  </row>

  <!-- =============================================================== -->
  <!-- ROW 2: CONFIGURATION DETAILS                                    -->
  <!-- =============================================================== -->
  <row>
    <panel>
      <title>âš™ï¸ Alert Configuration Review</title>
      <table>
        <search>
          <query>
            index=* sourcetype=sandfly:alerts:email
            | eval recipients_status=if(mvcount(email_recipients)>0,"âœ…","âŒ")
            | eval sender_status=if(isnull(email_sender) OR email_sender="","âŒ","âœ…")
            | eval auth_configured=if(isnull(mail_username) OR mail_username="","âŒ","âœ…")
            | table
                name
                email_sender
                mail_server
                mail_port
                recipients_status
                sender_status
                auth_configured
          </query>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>
  </row>

  <!-- =============================================================== -->
  <!-- ROW 3: DISTRIBUTION ANALYSIS                                    -->
  <!-- =============================================================== -->
  <row>

    <panel>
      <title>ğŸ“Š Recipient Distribution</title>
      <chart>
        <search>
          <query>
            index=* sourcetype=sandfly:alerts:email
            | mvexpand email_recipients
            | stats count by email_recipients
            | sort - count
          </query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>

    <panel>
      <title>ğŸ“Š Mail Server Distribution</title>
      <chart>
        <search>
          <query>
            index=* sourcetype=sandfly:alerts:email
            | stats count by mail_server
            | sort - count
          </query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>

  </row>

</dashboard>
