<!--
=============================================================================
 default/data/ui/views/sandfly_email_alerts.xml
 Sandfly Security for Splunk App
 Email Alert Configuration & Coverage Analysis
=============================================================================

PURPOSE

This view provides configuration-level visibility into Sandfly email alert
definitions ingested from the Sandfly Security API endpoint:

  GET /v4/alerts/email

The dashboard focuses strictly on alert DELIVERY CONFIGURATION, not alert
activity, and is intended to answer:

- Are any alerts misconfigured or silently failing?
- Is alert coverage resilient or dependent on single individuals?
- How concentrated is alert distribution across recipients?
- What mail infrastructure and authentication methods are in use?

This view does NOT infer alert severity, delivery success, or alert volume.
=============================================================================
-->

<dashboard version="1.1" theme="light">
  <label>Email Alerts</label>

  <!-- =============================================================== -->
  <!-- ROW 1: EXECUTIVE SUMMARY METRICS                                -->
  <!-- =============================================================== -->
  <row>
    <panel>
      <title>Total Email Alerts</title>
      <single>
        <search>
          <query>
            index=* sourcetype=sandfly:alerts:email
            | stats count
          </query>
        </search>
        <option name="colorMode">block</option>
        <option name="numberPrecision">0</option>
      </single>
    </panel>

    <panel>
      <title>Alerts With No Recipients</title>
      <single>
        <search>
          <query>
            index=* sourcetype=sandfly:alerts:email
            | eval recipient_count=mvcount(email_recipients)
            | search recipient_count=0 OR isnull(email_recipients)
            | stats count
          </query>
        </search>
        <option name="colorMode">block</option>
      </single>
    </panel>

    <panel>
      <title>Single-Recipient Alerts</title>
      <single>
        <search>
          <query>
            index=* sourcetype=sandfly:alerts:email
            | eval recipient_count=mvcount(email_recipients)
            | search recipient_count=1
            | stats count
          </query>
        </search>
        <option name="colorMode">block</option>
      </single>
    </panel>

    <panel>
      <title>Distinct Recipients</title>
      <single>
        <search>
          <query>
            index=* sourcetype=sandfly:alerts:email
            | mvexpand email_recipients
            | stats dc(email_recipients)
          </query>
        </search>
        <option name="colorMode">block</option>
      </single>
    </panel>
  </row>

  <!-- =============================================================== -->
  <!-- ROW 2: COVERAGE & RISK GAPS                                     -->
  <!-- =============================================================== -->
  <row>
    <panel>
      <title>Alert Coverage Risks</title>
      <table>
        <search>
          <query>
            index=* sourcetype=sandfly:alerts:email
            | eval recipient_count=mvcount(email_recipients)
            | eval risk=case(
                isnull(email_recipients) OR recipient_count=0, "No Recipients",
                recipient_count=1, "Single Recipient",
                true(), "OK"
              )
            | table name risk recipient_count email_sender mail_server
            | sort risk
          </query>
        </search>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

  <!-- =============================================================== -->
  <!-- ROW 3: RECIPIENT CONCENTRATION                                  -->
  <!-- =============================================================== -->
  <row>
    <panel>
      <title>Recipients by Alert Volume</title>
      <table>
        <search>
          <query>
            index=* sourcetype=sandfly:alerts:email
            | mvexpand email_recipients
            | stats count as alert_count by email_recipients
            | sort - alert_count
          </query>
        </search>
      </table>
    </panel>

    <panel>
      <title>Shared vs Unique Recipients</title>
      <chart>
        <search>
          <query>
            index=* sourcetype=sandfly:alerts:email
            | mvexpand email_recipients
            | stats count by email_recipients
            | eval recipient_type=if(count&gt;1,"Shared","Unique")
            | stats count by recipient_type
          </query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>

  <!-- =============================================================== -->
  <!-- ROW 4: MAIL INFRASTRUCTURE & AUTH POSTURE                       -->
  <!-- =============================================================== -->
  <row>
    <panel>
      <title>Mail Server Authentication Usage</title>
      <table>
        <search>
          <query>
            index=* sourcetype=sandfly:alerts:email
            | eval auth_type=if(isnull(mail_username) OR mail_username="",
                               "Anonymous / No Auth",
                               "Authenticated")
            | stats count by auth_type
          </query>
        </search>
      </table>
    </panel>

    <panel>
      <title>Mail Servers & Ports</title>
      <table>
        <search>
          <query>
            index=* sourcetype=sandfly:alerts:email
            | stats count by mail_server mail_port
            | sort - count
          </query>
        </search>
      </table>
    </panel>
  </row>

  <!-- =============================================================== -->
  <!-- ROW 5: FULL CONFIGURATION DETAIL                                -->
  <!-- =============================================================== -->
  <row>
    <panel>
      <title>Email Alert Configuration Details</title>
      <table>
        <search>
          <query>
            index=* sourcetype=sandfly:alerts:email
            | eval recipient_count=mvcount(email_recipients)
            | table
                name
                email_sender
                email_recipients
                recipient_count
                mail_server
                mail_port
                mail_username
          </query>
        </search>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

</dashboard>
