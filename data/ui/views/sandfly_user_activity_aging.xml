<!--
=============================================================================
 default/data/ui/views/sandfly_user_activity_aging.xml
 Sandfly Security for Splunk App
 User Activity & Account Aging
=============================================================================
-->

<dashboard version="1.1" theme="light">
  <label>üë§ User Activity & Aging</label>

  <!-- =============================================================== -->
  <!-- ROW 1: EXECUTIVE SUMMARY                                       -->
  <!-- =============================================================== -->
  <row>

    <panel>
      <title>üë• Total Users</title>
      <single>
        <search>
          <query>
            index=* sourcetype=sandfly:users
            | stats count
          </query>
        </search>
      </single>
    </panel>

    <panel>
      <title>‚ùå Never Logged In</title>
      <single>
        <search>
          <query>
            index=* sourcetype=sandfly:users
            | where isnull(last_login_date) OR last_login_date=""
            | stats count
          </query>
        </search>
      </single>
    </panel>

    <panel>
      <title>‚ö†Ô∏è Failed Logins</title>
      <single>
        <search>
          <query>
            index=* sourcetype=sandfly:users
            | where logins_failed_count&gt;0
            | stats count
          </query>
        </search>
      </single>
    </panel>

  </row>

  <!-- =============================================================== -->
  <!-- ROW 2: ACCOUNT AGE DISTRIBUTION                                 -->
  <!-- =============================================================== -->
  <row>

    <panel>
      <title>üïí Account Age Distribution</title>
      <chart>
        <search>
          <query>
            index=* sourcetype=sandfly:users
            | eval created_epoch=coalesce(
                strptime(created_date,"%Y-%m-%dT%H:%M:%S.%3NZ"),
                strptime(created_date,"%Y-%m-%dT%H:%M:%SZ")
              )
            | where isnotnull(created_epoch)
            | eval account_age_days=floor((now()-created_epoch)/86400)
            | eval age_index=floor(account_age_days/30)
            | eval age_bucket=case(
                age_index=0, "0-30 Days",
                age_index=1, "31-60 Days",
                age_index=2, "61-90 Days",
                age_index=3, "91-120 Days",
                age_index=4, "121-150 Days",
                age_index=5, "151-180 Days",
                true(),     "Over 180 Days"
              )
            | stats count by age_bucket
          </query>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>

  </row>

  <!-- =============================================================== -->
  <!-- ROW 3: ACTIVITY AGING (LOGIN)                                   -->
  <!-- =============================================================== -->
  <row>

    <panel>
      <title>‚è±Ô∏è Login Activity Aging</title>
      <chart>
        <search>
          <query>
            index=* sourcetype=sandfly:users
            | eval last_login_epoch=coalesce(
                strptime(last_login_date,"%Y-%m-%dT%H:%M:%S.%3NZ"),
                strptime(last_login_date,"%Y-%m-%dT%H:%M:%SZ")
              )
            | eval login_age_days=floor((now()-last_login_epoch)/86400)
            | eval login_index=floor(login_age_days/30)
            | eval login_bucket=case(
                isnull(last_login_epoch), "Never Logged In",
                login_index=0, "0-30 Days",
                login_index=1, "31-60 Days",
                login_index=2, "61-90 Days",
                login_index=3, "91-120 Days",
                login_index=4, "121-150 Days",
                login_index=5, "151-180 Days",
                true(),       "Over 180 Days"
              )
            | stats count by login_bucket
          </query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>

  </row>

  <!-- =============================================================== -->
  <!-- ROW 4: DETAILED REVIEW TABLE                                    -->
  <!-- =============================================================== -->
  <row>

    <panel>
      <title>üìã User Review Queue</title>
      <table>
        <search>
          <query>
            index=* sourcetype=sandfly:users
            | eval created_epoch=coalesce(
                strptime(created_date,"%Y-%m-%dT%H:%M:%S.%3NZ"),
                strptime(created_date,"%Y-%m-%dT%H:%M:%SZ")
              )
            | eval last_login_epoch=coalesce(
                strptime(last_login_date,"%Y-%m-%dT%H:%M:%S.%3NZ"),
                strptime(last_login_date,"%Y-%m-%dT%H:%M:%SZ")
              )
            | eval account_age_days=floor((now()-created_epoch)/86400)
            | eval login_age_days=if(isnull(last_login_epoch),null(),floor((now()-last_login_epoch)/86400))
            | table
                username
                email
                roles
                sso
                created_date
                last_login_date
                last_login_ip
                account_age_days
                login_age_days
                logins_failed_count
            | sort -account_age_days
          </query>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>

  </row>

</dashboard>
